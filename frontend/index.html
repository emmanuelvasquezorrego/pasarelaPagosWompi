<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Pago con Wompi</title>
  </head>
  <body>
    <h1>Pago con Wompi</h1>
    <form id="pagoForm">
      <input id="monto" placeholder="Monto" required />
      <input id="servicio" placeholder="Servicio" required />
      <input id="id_usuario" placeholder="Usuario" required />
      <input id="id_cliente" placeholder="Cliente" required />
      <input id="id_cita" placeholder="Cita" required />
      <button type="submit">Pagar</button>
    </form>

    <div id="widgetContainer"></div>

    <script>
      document.getElementById('pagoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
          monto: document.getElementById('monto').value,
          servicio: document.getElementById('servicio').value,
          id_usuario: document.getElementById('id_usuario').value,
          id_cliente: document.getElementById('id_cliente').value,
          id_cita: document.getElementById('id_cita').value,
        };

        try {
          // 游댳 Crear transacci칩n (el backend devolver치 publicKey y acceptance_token)
          const response = await fetch('http://localhost:3000/transacciones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const result = await response.json();

          if (!result.publicKey || !result.acceptance_token) {
            alert("Error: el backend no devolvi칩 los datos necesarios");
            return;
          }

          // 游댳 Limpiar contenedor antes de renderizar el widget
          document.getElementById('widgetContainer').innerHTML = '';

          // 游댳 Insertar el script del widget de Wompi
          const script = document.createElement('script');
          script.src = 'https://checkout.wompi.co/widget.js';
          script.setAttribute('data-render', 'button');
          script.setAttribute('data-public-key', result.publicKey);
          script.setAttribute('data-currency', 'COP');
          script.setAttribute('data-amount-in-cents', result.amount_in_cents);
          script.setAttribute('data-reference', result.reference);
          script.setAttribute('data-signature:integrity', result.signature);
          script.setAttribute('data-redirect-url', result.redirect_url);
          script.setAttribute('data-acceptance-token', result.acceptance_token);
          document.getElementById('widgetContainer').appendChild(script);

        } catch (err) {
          console.error('Error al crear transacci칩n:', err);
        }
      });
    </script>
  </body>
</html>